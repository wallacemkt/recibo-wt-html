<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gerador de Recibos | iOS Style (Atualizado - IA Local)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* --- iOS26 / Liquid Glass inspired theme --- */
    :root{
      --bg: linear-gradient(180deg,#07101a,#0b1220);
      --glass: rgba(255,255,255,0.06);
      --card: rgba(255,255,255,0.04);
      --muted: #9aa4b2;
      --text: #e6eef8;
      --accent: #0a84ff;
      --border: rgba(255,255,255,0.08);
      --recibo-bg: #ffffff;
      --recibo-text: #0b1220;
      --radius: 16px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0;
      font-family: 'Inter', -apple-system, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:28px 20px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;gap:14px;align-items:center;padding:18px 12px;border-radius:calc(var(--radius) + 2px);background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.03)}
    .logo-icon{width:68px;height:68px;border-radius:20px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),#5ac8fa);color:white;box-shadow:0 10px 30px rgba(10,132,255,0.14);font-size:24px;backdrop-filter:blur(6px);} 
    header h1{font-size:20px;margin:0;font-weight:700;letter-spacing:-0.02em;font-family:'Inter', -apple-system, "SF Pro Text", "SF Pro Display", "Segoe UI", Roboto, Arial, sans-serif;} header small{display:block;color:var(--muted);font-size:13px;font-weight:400;}

    .grid{display:grid;gap:18px;grid-template-columns:1fr}
    @media(min-width:1000px){.grid{grid-template-columns:1fr 440px}}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius:28px;
      padding:20px;
      border:1px solid rgba(255,255,255,0.12);
      backdrop-filter: blur(22px) saturate(150%);
      -webkit-backdrop-filter: blur(22px) saturate(150%);
      box-shadow: 0 12px 40px rgba(2,6,23,0.55), inset 0 1px 0 rgba(255,255,255,0.03);
    }

    label{display:block;color:var(--muted);font-size:13px;margin-bottom:8px}
    .required:after{content:" *";color:var(--accent)}
    input,select,textarea{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.03);
      background: rgba(255,255,255,0.025);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    input::placeholder, textarea::placeholder { color: rgba(255,255,255,0.35); }
    textarea{min-height:110px}
    .row{display:grid;gap:12px}
    @media(min-width:640px){.row-2{grid-template-columns:1fr 1fr}.row-3{grid-template-columns:1fr 1fr 1fr}}
    .file-input-container{position:relative}
    .file-input-container input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer}
    .file-input-label{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;border:1px dashed rgba(255,255,255,0.03);color:var(--muted)}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:12px;border:none;font-weight:700;cursor:pointer}
    button.primary{background:linear-gradient(180deg,var(--accent),#076fe0);color:white}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(10,132,255,0.08)}
    button.flat{background:transparent;color:var(--muted)}

    /* preview (white) */
    .recibo{
      background: #ffffff;
      color: #0b1220;
      padding:22px;
      border-radius:16px;
      border:1px solid rgba(0,0,0,0.06);
      box-shadow: 0 8px 30px rgba(2,6,23,0.08);
      backdrop-filter: none;
      -webkit-backdrop-filter: none;
    }
    .body{margin-top:14px}
    .line{display:flex;gap:12px;align-items:flex-start;padding:8px 0;border-bottom:1px dashed rgba(0,0,0,0.04)}
    .line label{width:160px;color:#6b7280}
    .val{flex:1}
    .desc{margin-top:10px;padding:12px;border-radius:10px;background:#fbfbfc;color:#64748b;font-size:13px;border:1px solid rgba(0,0,0,0.03)}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:18px}
    .assin .trace{width:240px;border-top:1px solid rgba(0,0,0,0.06);height:0;margin-top:36px}
    .toast{position:fixed;right:20px;bottom:20px;background:var(--card);padding:12px;border-radius:12px;border:1px solid var(--border);display:flex;gap:12px;color:var(--text);opacity:0;transform:translateY(12px);transition:all .28s}
    .toast.show{opacity:1;transform:translateY(0)}
    @media print{body *{visibility:hidden}.recibo,.recibo *{visibility:visible}.recibo{position:absolute;left:0;top:0;width:100%;background:#fff;color:#000;border:none}}
    .error-message{color:#ff6b6b;font-size:12px;display:none;margin-top:6px}
    input.invalid,textarea.invalid{box-shadow:0 0 0 4px rgba(239,68,68,0.08)}
    /* subtle iOS-like controls */
    select{appearance:none;background-image:linear-gradient(45deg,transparent 50%, rgba(0,0,0,0.12) 50%), linear-gradient(135deg, rgba(0,0,0,0.06) 50%, transparent 50%); background-position:calc(100% - 20px) calc(1em + 2px), calc(100% - 15px) calc(1em + 2px); background-size:6px 6px, 6px 6px; background-repeat:no-repeat; padding-right:40px;}

    /* small modal styles */
    .modal-backdrop{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.6);z-index:3000;align-items:center;justify-content:center}
    .modal{width:92%;max-width:720px;background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border)}
    .modal h3{margin:0 0 8px 0}

  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo-icon"><i class="fas fa-file-invoice-dollar"></i></div>
      <div>
        <h1>Recibos</h1>
        <small>Preencha e gere PDF — WT GOMES</small>
      </div>
    </header>

    <div class="grid">
      <!-- form -->
      <section class="card form" aria-label="Formulário de Recibo">
        <div class="h"><h2><i class="fas fa-edit"></i> Dados</h2></div>
        <div class="b">
          <div class="row row-2">
            <div class="form-group">
              <label class="required">Recebedor</label>
              <input id="recebedor" placeholder="Nome / Razão social" />
              <div class="error-message" id="recebedor-error">Obrigatório</div>
            </div>
            <div class="form-group">
              <label class="required">CPF/CNPJ</label>
              <input id="docRecebedor" placeholder="000.000.000-00" />
              <div class="error-message" id="docRecebedor-error">Inválido</div>
            </div>
            <div class="form-group">
              <label class="required">Pagador</label>
              <input id="pagador" placeholder="Nome do pagador" />
              <div class="error-message" id="pagador-error">Obrigatório</div>
            </div>
            <div class="form-group">
              <label class="required">CPF/CNPJ</label>
              <input id="docPagador" placeholder="000.000.000-00" />
              <div class="error-message" id="docPagador-error">Inválido</div>
            </div>
          </div>

          <div class="row">
            <div class="form-group">
              <label class="required">Descrição</label>
              <textarea id="descricao" placeholder="Descrição" spellcheck="true" autocorrect="on" autocapitalize="sentences"></textarea>
              <div style="display:flex;gap:8px;margin-top:6px">
                <button type="button" id="checkSpelling" class="ghost">Verificar ortografia</button>
                <button type="button" id="openAIButton" class="primary">Gerar com IA (local)</button>
              </div>
              <div class="error-message" id="descricao-error">Obrigatório</div>
            </div>
          </div>

          <div class="row row-3">
            <div class="form-group">
              <label class="required">Valor (R$)</label>
              <input id="valor" inputmode="decimal" placeholder="0,00" />
              <div class="error-message" id="valor-error">Inválido</div>
            </div>
            <div class="form-group">
              <label class="required">Data</label>
              <input id="data" type="date" />
            </div>
            <div class="form-group">
              <label class="required">Cidade/UF</label>
              <input id="cidade" placeholder="Cidade/UF" />
              <div class="error-message" id="cidade-error">Obrigatório</div>
            </div>
          </div>

          <div class="row row-2">
            <div class="form-group">
              <label class="required">Forma de pagamento</label>
              <select id="forma" aria-label="Forma de pagamento">
                <option value="PIX">PIX</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Cartão de crédito">Cartão crédito</option>
                <option value="Cartão de débito">Cartão débito</option>
                <option value="Transferência bancária">Transferência bancária</option>
                <option value="Boleto bancário">Boleto</option>
                <option value="Cheque">Cheque</option>
                <option value="Outro">Outro</option>
              </select>
            </div>

            <div class="form-group">
              <label>Nº do recibo</label>
              <input id="numero" />
            </div>
          </div>

          <!-- holder onde os campos dinâmicos serão inseridos -->
          <div id="paymentDetailsHolder" style="margin-top:8px"></div>

          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button class="primary" id="gerar">Atualizar</button>
            <button id="imprimir">PDF</button>
            <button class="ghost" id="limpar">Limpar</button>
            <button class="flat" id="assinar">Assinar</button>
          </div>
        </div>
      </section>

      <!-- preview -->
      <section class="card preview" aria-label="Pré-visualização">
        <div class="h"><h2><i class="fas fa-eye"></i> Pré-visualização</h2></div>
        <div class="b">
          <div class="recibo" id="view">
            <div class="top" style="display:flex;justify-content:space-between;align-items:center">
              <div class="brand">
                <div class="logo"><img id="logoPreview" alt="logo" style="display:none;max-width:100%;height:auto"/></div>
                <div class="txt"><b id="vRecebedor">Recebedor</b><br/><small id="vDocRecebedor" class="muted">CPF/CNPJ</small></div>
              </div>
              <div class="code"><div>RECIBO</div><div>Nº <span id="vNumero">00001</span></div><div class="muted"><span id="vDataTop">01 de janeiro de 2025</span></div></div>
            </div>

            <div class="body">
              <div class="line"><label>Recebi(emos) de</label><div class="val" id="vPagador">Pagador</div></div>
              <div class="line"><label>CPF/CNPJ</label><div class="val" id="vDocPagador">000.000.000-00</div></div>
              <div class="line"><label>O valor de</label><div class="val"><span id="vValor">R$ 0,00</span> (<span id="vExtenso">zero real</span>)</div></div>
              <div class="line"><label>Referente a</label><div class="val" id="vDescricao">Descrição</div></div>
              <div class="line"><label>Forma de pagamento</label><div class="val" id="vForma">PIX</div></div>
              <div class="line" id="paymentInfoLine"><label>Dados de pagamento</label><div class="val" id="vPaymentInfo">—</div></div>
              <div class="desc"><small id="vObs" class="muted">Observações</small></div>
              <div style="display:flex;justify-content:flex-end;margin-top:12px" class="muted"><span id="vCidadeData">Cidade/UF, 01 de janeiro de 2025</span></div>
            </div>

            <div class="footer">
              <div class="assin">
                <div id="signatureContainer"><div class="trace" id="trace"></div><img id="signatureImg" style="display:none;max-width:280px;border-radius:6px"/></div>
                <div><b>Assinatura do Recebedor</b></div>
                <div class="muted" id="vRecebedor2">Recebedor</div>
                <div style="margin-top:8px"><button class="flat" id="clearSignatureInline">Limpar assinatura</button></div>
              </div>
              <div><div><b>Total:</b> <span id="vValor2">R$ 0,00</span></div><div class="muted" style="font-size:13px;margin-top:6px">Documento sem valor fiscal</div></div>
            </div>
          </div>
          <div style="margin-top:12px;color:var(--muted);font-size:13px">Clique em <b>PDF</b> para salvar</div>
        </div>
      </section>
    </div>
  </div>

  <!-- signature modal -->
  <div id="signatureModal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:2000">
    <div style="width:90%;max-width:640px;background:var(--card);border-radius:12px;padding:12px;border:1px solid var(--border)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong style="color:var(--text)">Assinar</strong>
        <div>
          <button id="sigClear" class="flat">Limpar</button>
          <button id="sigCancel" class="ghost">Cancelar</button>
          <button id="sigSave" class="primary">Salvar</button>
        </div>
      </div>
      <div style="background:rgba(255,255,255,0.02);border-radius:8px;padding:8px">
        <canvas id="signaturePad" style="width:100%;height:220px;background:#fff;border-radius:6px;touch-action:none"></canvas>
      </div>
      <small style="color:var(--muted);display:block;margin-top:8px">Assine com mouse, touch ou caneta.</small>
    </div>
  </div>

  <!-- AI modal (Local generator) -->
  <div id="aiModal" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="aiModalTitle">
      <h3 id="aiModalTitle">Gerar descrição com IA (local)</h3>
      <p style="color:var(--muted);font-size:13px;margin-top:6px">Gerador local de texto: não utiliza API externa. Use o campo abaixo para ajustar o resultado (tom e comprimento).</p>
      <div style="display:grid;gap:8px;margin-top:10px">
        <label>Seed / Prompt (opcional)</label>
        <input id="localSeed" placeholder="Ex: pagamento de prestação, aluguel, venda de serviços..." />
        <label>Template</label>
        <select id="simplifiedTemplate">
          <option value="freestyle">Freestyle (curto)</option>
          <option value="paragraph-writer">Parágrafo</option>
          <option value="article-writer">Mais detalhado</option>
        </select>
        <label>Comprimento (palavras aproximadas)</label>
        <input id="aiLength" type="number" min="20" max="2000" value="60" />
        <label>Tono</label>
        <select id="aiTone">
          <option value="formal">Formal</option>
          <option value="informal">Informal</option>
          <option value="neutral">Neutro</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="aiClose" class="flat">Fechar</button>
        <button id="aiGenerate" class="primary">Gerar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><i class="fas fa-check-circle"></i><div id="toast-message">Atualizado</div></div>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <script>
    const $$ = id => document.getElementById(id);
    const today = new Date();
    const pad = n => String(n).padStart(2,'0');

    function parseDateInput(v){ if(!v) return null; const p = v.split('-').map(Number); return new Date(p[0], p[1]-1, p[2]); }
    function formatDate(d){ return new Intl.DateTimeFormat('pt-BR',{day:'2-digit',month:'long',year:'numeric'}).format(d); }

    const defaultNum = () => { const n = new Date(); return `REC${n.getFullYear()}${pad(n.getMonth()+1)}${pad(n.getDate())}-${Math.floor(Math.random()*90000)+10000}`; };

    const campos = {
      recebedor: $$('recebedor'),
      docRecebedor: $$('docRecebedor'),
      pagador: $$('pagador'),
      docPagador: $$('docPagador'),
      descricao: $$('descricao'),
      valor: $$('valor'),
      data: $$('data'),
      cidade: $$('cidade'),
      forma: $$('forma'),
      numero: $$('numero'),
      obs: $$('obs'),
      logo: $$('logo') /* compatibility */
    };
    const v = {
      recebedor: $$('vRecebedor'),
      docRecebedor: $$('vDocRecebedor'),
      recebedor2: $$('vRecebedor2'),
      pagador: $$('vPagador'),
      docPagador: $$('vDocPagador'),
      valor: $$('vValor'),
      valor2: $$('vValor2'),
      extenso: $$('vExtenso'),
      descricao: $$('vDescricao'),
      forma: $$('vForma'),
      obs: $$('vObs'),
      numero: $$('vNumero'),
      dataTop: $$('vDataTop'),
      cidadeData: $$('vCidadeData'),
      logoPreview: $$('logoPreview'),
      paymentInfo: $$('vPaymentInfo')
    };
    const nf = new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'});

    function setCurrencyMask(el){ if(!el) return; el.addEventListener('input', e=>{ let v = e.target.value.replace(/\D/g,''); v = (Number(v)/100).toFixed(2); e.target.value = v ? nf.format(v) : ''; }); el.addEventListener('blur', ()=>{ if(!el.value.trim()) el.value = nf.format(0); }); }
    function setDocMask(el){ if(!el) return; el.addEventListener('input', e=>{ let v = e.target.value.replace(/\D/g,''); if(v.length>11) v = v.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{0,2}).*/,'$1.$2.$3/$4-$5'); else v = v.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2}).*/,'$1.$2.$3-$4'); e.target.value = v; }); }
    setCurrencyMask(campos.valor); setDocMask(campos.docRecebedor); setDocMask(campos.docPagador);

    function validateField(field, errorId, msg){ if(!field || !field.value || !field.value.toString().trim()){ if(field) field.classList.add('invalid'); if(errorId && $$(errorId)) { $$(errorId).style.display='block'; $$(errorId).textContent = msg || 'Obrigatório'; } return false; } if(field.id && field.id.includes('doc')){ const doc = field.value.replace(/\D/g,''); if(!(doc.length===11 || doc.length===14)){ field.classList.add('invalid'); if(errorId && $$(errorId)) { $$(errorId).style.display='block'; $$(errorId).textContent = 'Inválido'; } return false; } } if(field.id === 'valor'){ const val = parseFloat(field.value.replace(/\D/g,''))/100; if(isNaN(val) || val<0){ field.classList.add('invalid'); if(errorId && $$(errorId)){ $$(errorId).style.display='block'; $$(errorId).textContent='Inválido'; } return false; } } field.classList.remove('invalid'); if(errorId && $$(errorId)) $$(errorId).style.display='none'; return true; }

    function validateForm(){ let ok = true; if(!validateField(campos.recebedor,'recebedor-error')) ok=false; if(!validateField(campos.docRecebedor,'docRecebedor-error')) ok=false; if(!validateField(campos.pagador,'pagador-error')) ok=false; if(!validateField(campos.docPagador,'docPagador-error')) ok=false; if(!validateField(campos.descricao,'descricao-error')) ok=false; if(!validateField(campos.valor,'valor-error')) ok=false; if(!validateField(campos.cidade,'cidade-error')) ok=false; const forma = (campos.forma && campos.forma.value) ? campos.forma.value : ''; if(forma === 'PIX'){ if(!campos.pixKey || !validateField(campos.pixKey,'pixKey-error')) ok=false; } else if(forma === 'Transferência bancária' ){ if(!campos.bankName || !validateField(campos.bankName,'bankName-error')) ok=false; if(!campos.bankAgency || !validateField(campos.bankAgency,'bankAgency-error')) ok=false; if(!campos.bankAccount || !validateField(campos.bankAccount,'bankAccount-error')) ok=false; } return ok; }

    function showToast(msg,d=3000){ const t = $$('toast'); $$('toast-message').textContent = msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),d); }

    // extenso
    function numeroPorExtenso(n){ const u=["zero","um","dois","três","quatro","cinco","seis","sete","oito","nove","dez","onze","doze","treze","quatorze","quinze","dezesseis","dezessete","dezoito","dezenove"]; const d=["","","vinte","trinta","quarenta","cinquenta","sessenta","setenta","oitenta","noventa"]; const c=["","cento","duzentos","trezentos","quatrocentos","quinhentos","seiscentos","setecentos","oitocentos","novecentos"]; if(n===0) return u[0]; function grupo(nm){ if(nm===0) return ""; const C=Math.floor(nm/100), D=Math.floor((nm%100)/10), U=nm%10; let t=""; if(C>0){ if(C===1 && D===0 && U===0) t="cem"; else t=c[C]; } if(D>0){ if(t) t+=" e "; if(D===1) t+=u[10+U]; else{ t+=d[D]; if(U>0) t+=" e "+u[U]; } } else if(U>0){ if(t) t+=" e "; t+=u[U]; } return t; } const bil = Math.floor(n/1000000000), mil = Math.floor((n%1000000000)/1000000), milh = Math.floor((n%1000000)/1000), uni = n%1000; let txt=""; if(bil>0) txt+=grupo(bil)+(bil===1?" bilhão":" bilhões"); if(mil>0) txt+=(txt?", ":"")+grupo(mil)+(mil===1?" milhão":" milhões"); if(milh>0) txt+=(txt?", ":"")+(milh===1?"mil":grupo(milh)+" mil"); if(uni>0) txt+=(txt?", ":"")+grupo(uni); return txt; }
    function valorExtensoBR(v){ const r=Math.floor(v), c=Math.round((v-r)*100); let t=numeroPorExtenso(r); t+= r===1? " real":" reais"; if(c>0) t+=" e "+numeroPorExtenso(c)+(c===1?" centavo":" centavos"); return t; }

    function atualizarPreview(fullValidation=false){ if(fullValidation && !validateForm()){ showToast('Preencha os campos obrigatórios',3000); return; } const r = campos.recebedor.value || "—"; const dR = campos.docRecebedor.value || "—"; const p = campos.pagador.value || "—"; const dP = campos.docPagador.value || "—"; const desc = campos.descricao.value || "—"; const forma = campos.forma.value || "—"; const numero = campos.numero.value || defaultNum(); const obs = campos.obs && campos.obs.value ? campos.obs.value : "—"; const data = campos.data.value ? parseDateInput(campos.data.value) : today; const cidade = campos.cidade.value || "—"; const valorStr = (campos.valor.value||'').replace(/\D/g,''); const vNum = valorStr ? parseFloat(valorStr)/100 : 0;

      v.recebedor.textContent = r;
      v.docRecebedor.textContent = dR;
      v.recebedor2.textContent = r;
      v.pagador.textContent = p;
      v.docPagador.textContent = dP;
      v.valor.textContent = nf.format(vNum);
      v.valor2.textContent = nf.format(vNum);
      v.extenso.textContent = valorExtensoBR(vNum);
      v.descricao.textContent = desc;
      v.forma.textContent = forma;
      v.numero.textContent = numero;
      v.obs.textContent = obs;
      const dataFmt = formatDate(data);
      v.dataTop.textContent = dataFmt;
      v.cidadeData.textContent = `${cidade}, ${dataFmt}`;

      // payment info
      const pay = document.getElementById('vPaymentInfo');
      if(pay){
        if(forma==='PIX') pay.textContent = (campos.pixKey && campos.pixKey.value)?campos.pixKey.value:'—';
        else if(forma==='Transferência bancária' ){
          const parts=[]; if(campos.bankName && campos.bankName.value) parts.push(campos.bankName.value);
            if(campos.bankAgency && campos.bankAgency.value) parts.push('Ag: '+campos.bankAgency.value);
            if(campos.bankAccount && campos.bankAccount.value) parts.push('Cc: '+campos.bankAccount.value);
            if(campos.bankType && campos.bankType.value) parts.push(campos.bankType.value);
            if(campos.bankHolder && campos.bankHolder.value) parts.push('Titular: '+campos.bankHolder.value);
          pay.textContent = parts.length?parts.join(' • '):'—';
        } else pay.textContent='—';
      }

      if(fullValidation) showToast('Atualizado');
    }

    function limparErrosVisuais(){ document.querySelectorAll('.error-message').forEach(e=>e.style.display='none'); document.querySelectorAll('.invalid').forEach(e=>e.classList.remove('invalid')); }

    function gerarPDF(){ if(!validateForm()){ showToast('Preencha os campos obrigatórios antes do PDF',3000); return; } const el = document.getElementById('view'); const filename = (campos.numero.value && campos.numero.value.length?campos.numero.value:defaultNum()) + '.pdf'; const opt = { margin:[10,10,10,10], filename, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2,useCORS:true}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} }; showToast('Gerando PDF...',2000); html2pdf().set(opt).from(el).save().then(()=>showToast('PDF gerado!',2000)).catch(e=>{ console.error(e); showToast('Erro ao gerar PDF',3000); }); }

    // signature pad
    let sigCanvas=null, sigCtx=null, drawing=false;
    function openSignature(){ document.getElementById('signatureModal').style.display='flex'; initSignatureCanvas(); }
    function closeSignatureModal(){ document.getElementById('signatureModal').style.display='none'; }
    function initSignatureCanvas(){ const c = document.getElementById('signaturePad'); if(!c) return; sigCanvas = c; sigCtx = c.getContext('2d'); resizeSigCanvas(); sigCtx.strokeStyle='#000'; sigCtx.lineWidth=2.5; sigCtx.lineCap='round';
      // pointer events
      c.onpointerdown = startSig; c.onpointermove = moveSig; c.onpointerup = endSig; c.onpointercancel = endSig; window.addEventListener('resize', resizeSigCanvas);
    }
    function resizeSigCanvas(){ if(!sigCanvas) return; const ratio = window.devicePixelRatio || 1; const w = sigCanvas.clientWidth, h = sigCanvas.clientHeight; sigCanvas.width = Math.floor(w*ratio); sigCanvas.height = Math.floor(h*ratio); sigCtx.setTransform(ratio,0,0,ratio,0,0); sigCtx.fillStyle='#fff'; sigCtx.fillRect(0,0,w,h); }
    function startSig(e){ if(!sigCanvas) return; drawing=true; const r = sigCanvas.getBoundingClientRect(); sigCtx.beginPath(); sigCtx.moveTo(e.clientX - r.left, e.clientY - r.top); try{ sigCanvas.setPointerCapture && sigCanvas.setPointerCapture(e.pointerId); }catch(_){} e.preventDefault(); }
    function moveSig(e){ if(!drawing || !sigCanvas) return; const r = sigCanvas.getBoundingClientRect(); sigCtx.lineTo(e.clientX - r.left, e.clientY - r.top); sigCtx.stroke(); e.preventDefault(); }
    function endSig(e){ drawing=false; try{ sigCanvas.releasePointerCapture && sigCanvas.releasePointerCapture(e && e.pointerId); }catch(_){} }
    function clearSig(){ if(!sigCtx||!sigCanvas) return; sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height); sigCtx.setTransform(1,0,0,1,0,0); sigCtx.fillStyle='#fff'; sigCtx.fillRect(0,0,sigCanvas.clientWidth,sigCanvas.clientHeight); }
    function saveSignature(){ if(!sigCanvas) return; const data = sigCanvas.toDataURL('image/png'); const img = document.getElementById('signatureImg'); img.src = data; img.style.display='block'; document.getElementById('trace').style.display='none'; closeSignatureModal(); }

    // Local IA generator (no external API)
    function generateLocalAI(template, seed, tone, length){
      // basic deterministic generator that composes a natural receipt description in Portuguese
      const recebedor = (campos.recebedor && campos.recebedor.value) ? campos.recebedor.value : 'o Recebedor';
      const pagador = (campos.pagador && campos.pagador.value) ? campos.pagador.value : 'o Pagador';
      const valorStr = (campos.valor && campos.valor.value)?campos.valor.value.replace(/\D/g,'') : '0';
      const vNum = valorStr ? parseFloat(valorStr)/100 : 0;
      const valorExt = valorExtensoBR(vNum);
      const forma = (campos.forma && campos.forma.value) ? campos.forma.value : 'PIX';
      const data = campos.data && campos.data.value ? formatDate(parseDateInput(campos.data.value)) : formatDate(new Date());
      const cidade = (campos.cidade && campos.cidade.value)?campos.cidade.value : 'Cidade/UF';
      const baseSeed = seed && seed.trim() ? seed.trim() : '';

      // template variations
      let text = '';
      if(template === 'freestyle'){
        text = `${recebedor} declara ter recebido de ${pagador} a quantia de ${nf.format(vNum)} (${valorExt})${ baseSeed ? ' — ' + baseSeed : '' }.`;
      } else if(template === 'paragraph-writer'){
        text = `Declaro para os devidos fins que ${recebedor} recebeu de ${pagador} o valor de ${nf.format(vNum)} (${valorExt}), referente a ${ baseSeed || 'serviços prestados' }. Pagamento efetuado em ${data}, na cidade de ${cidade}, por meio de ${forma}.`;
      } else {
        // article-writer -> mais detalhado
        text = `Pelo presente recibo, ${recebedor} recebe de ${pagador} a importância de ${nf.format(vNum)} (${valorExt}). O pagamento refere-se a ${ baseSeed || 'serviço ou produto acordado entre as partes' } e foi realizado em ${data}, em ${cidade}, mediante ${forma}. Fica o presente para comprovação do recebimento.`;
      }

      // tone adjustments (small stylistic changes)
      if(tone === 'formal'){
        text = text.replace(/^/,''); // already formal by templates
      } else if(tone === 'informal'){
        text = text.replace(/Declaro para os devidos fins que /,'').replace(/Pelo presente recibo, /,'');
        if(!text.startsWith('Recebi')) text = 'Recebi de ' + text.charAt(0).toLowerCase() + text.slice(1);
      }

      // length control: if requested larger, append short clarifications until approximate
      const words = text.split(/\s+/).filter(Boolean).length;
      if(length && length > words){
        const filler = ' Este documento serve como comprovante de pagamento e foi emitido para registro e controle entre as partes.';
        while(text.split(/\s+/).filter(Boolean).length < length){
          text += filler;
          if(text.split(/\s+/).filter(Boolean).length > length + 30) break; // safety
        }
      }

      return text.trim();
    }

    function openAIModal(){ const modal = document.getElementById('aiModal'); if(!modal) return; modal.style.display='flex'; }
    function closeAIModal(){ const modal = document.getElementById('aiModal'); if(!modal) return; modal.style.display='none'; }

    function generateWithSimplified(){ // now local
      const template = document.getElementById('simplifiedTemplate').value || 'freestyle'; const length = Number(document.getElementById('aiLength').value) || 60; const tone = document.getElementById('aiTone').value || 'neutral'; const seed = document.getElementById('localSeed').value || '';
      showToast('Gerando descrição local...',1200);
      try{
        const generated = generateLocalAI(template, seed, tone, length);
        campos.descricao.value = generated;
        atualizarPreview(false);
        showToast('Descrição gerada localmente — revise e ajuste');
        closeAIModal();
      }catch(err){ console.error(err); showToast('Erro ao gerar descrição localmente'); }
    }

    // init
    function init(){
      campos.data.valueAsDate = today; campos.numero.value = defaultNum(); campos.valor.value = nf.format(0);

      // habilitar corretor para a descrição e botão de verificação
      try{ if(campos.descricao){ campos.descricao.setAttribute('spellcheck','true'); campos.descricao.setAttribute('autocorrect','on'); campos.descricao.setAttribute('autocapitalize','sentences'); } }catch(e){}
      const checkBtn = document.getElementById('checkSpelling'); if(checkBtn){ checkBtn.addEventListener('click', e=>{ e.preventDefault(); const el = campos.descricao; if(!el) return; el.spellcheck = false; setTimeout(()=>{ el.spellcheck = true; el.focus(); el.blur(); showToast('Verificação de ortografia ativada'); }, 60); }); }

      // open AI modal
      const openBtn = document.getElementById('openAIButton'); if(openBtn){ openBtn.addEventListener('click', e=>{ e.preventDefault(); openAIModal(); }); }
      document.getElementById('aiClose').addEventListener('click', e=>{ e.preventDefault(); closeAIModal(); });
      document.getElementById('aiGenerate').addEventListener('click', e=>{ e.preventDefault(); generateWithSimplified(); });

      // create payment fields inside holder (PIX + Transferência)
      (function(){
        const holder = document.getElementById('paymentDetailsHolder');
        if(!holder) return;
        holder.innerHTML = `
          <div id="pixGroup" style="display:none">
            <label class="required">Chave PIX</label>
            <input id="pixKey" placeholder="CPF, celular, número ou e-mail (ex: 000.000.000-00 / +55 11 9xxxx-xxxx / nome@exemplo.com)" />
            <div class="error-message" id="pixKey-error">Obrigatório</div>
          </div>
          <div id="transferGroup" style="display:none;margin-top:8px">
            <label class="required">Banco</label>
            <input id="bankName" placeholder="Nome do banco (ex: Banco do Brasil)" />
            <div class="error-message" id="bankName-error">Obrigatório</div>
            <label class="required" style="margin-top:8px">Agência</label>
            <input id="bankAgency" placeholder="0000" />
            <div class="error-message" id="bankAgency-error">Obrigatório</div>
            <label class="required" style="margin-top:8px">Conta</label>
            <input id="bankAccount" placeholder="000000-0" />
            <div class="error-message" id="bankAccount-error">Obrigatório</div>
            <label style="margin-top:8px">Tipo de conta</label>
            <select id="bankType">
              <option value="Conta corrente">Conta corrente</option>
              <option value="Poupança">Poupança</option>
            </select>
            <label style="margin-top:8px">Titular (opcional)</label>
            <input id="bankHolder" placeholder="Nome do titular" />
          </div>
        `;
        // wire into campos
        campos.pixKey = document.getElementById('pixKey'); campos.bankName = document.getElementById('bankName'); campos.bankAgency = document.getElementById('bankAgency');
        campos.bankAccount = document.getElementById('bankAccount'); campos.bankType = document.getElementById('bankType'); campos.bankHolder = document.getElementById('bankHolder');
        if(campos.bankType) campos.bankType.value = 'Conta corrente';

        function onPaymentChange(){
          const f = (campos.forma && campos.forma.value) ? campos.forma.value : '';
          const pixG = document.getElementById('pixGroup'), trG = document.getElementById('transferGroup');
          // Show/hide groups
          if(f === 'PIX'){ if(pixG) pixG.style.display='block'; if(trG) trG.style.display='none'; }
          else if(f === 'Transferência bancária'){ if(pixG) pixG.style.display='none'; if(trG) trG.style.display='block'; }
          else { if(pixG) pixG.style.display='none'; if(trG) trG.style.display='none'; }

          // update preview payment info immediately (include tipo de conta quando presente)
          const vPay = document.getElementById('vPaymentInfo'); if(!vPay) return;
          if(f==='PIX'){ vPay.textContent = (campos.pixKey && campos.pixKey.value)?campos.pixKey.value:'—'; }
          else if(f==='Transferência bancária'){
            const parts = []; if(campos.bankName && campos.bankName.value) parts.push(campos.bankName.value); if(campos.bankAgency && campos.bankAgency.value) parts.push('Ag: '+campos.bankAgency.value); if(campos.bankAccount && campos.bankAccount.value) parts.push('Cc: '+campos.bankAccount.value); if(campos.bankType && campos.bankType.value) parts.push(campos.bankType.value); if(campos.bankHolder && campos.bankHolder.value) parts.push('Titular: '+campos.bankHolder.value); vPay.textContent = parts.length?parts.join(' • '):'—'; }
          else vPay.textContent='—';
        }
        campos.forma.addEventListener('change', onPaymentChange);
        ['pixKey','bankName','bankAgency','bankAccount','bankHolder'].forEach(id=>{ const e=document.getElementById(id); if(e){ e.addEventListener('input', onPaymentChange); e.addEventListener('change', onPaymentChange); } });
        const bankTypeEl = document.getElementById('bankType'); if(bankTypeEl){ bankTypeEl.addEventListener('change', onPaymentChange); bankTypeEl.addEventListener('input', onPaymentChange); }
        window.onPaymentChange = onPaymentChange;
        onPaymentChange();
      })();

      // logo file - keep safe (compat)
      if(campos.logo) campos.logo.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f){ v.logoPreview.style.display='none'; v.logoPreview.src=''; return; } const r=new FileReader(); r.onload=()=>{ v.logoPreview.src=r.result; v.logoPreview.style.display='block'; }; r.readAsDataURL(f); });

      // buttons
      document.getElementById('gerar').addEventListener('click', e=>{ e.preventDefault(); atualizarPreview(true); });
      const printToPdf = e=>{ e.preventDefault(); gerarPDF(); };
      document.getElementById('imprimir').addEventListener('click', printToPdf);

      document.getElementById('limpar').addEventListener('click', e=>{
        e.preventDefault();
        Object.values(campos).forEach(el=>{ if(!el) return; try{ if(el.type==='file'){ el.value=''; if(v.logoPreview) v.logoPreview.style.display='none'; } else if(el.type==='date'){ el.valueAsDate = today; } else el.value=''; }catch(_){} });
        campos.data.valueAsDate = today; campos.numero.value = defaultNum(); campos.valor.value = nf.format(0);
        try{ if(campos.forma) campos.forma.value='PIX'; }catch(e){}
        try{ if(campos.bankType) campos.bankType.value='Conta corrente'; }catch(e){}
        try{ if(typeof window.onPaymentChange === 'function') window.onPaymentChange(); }catch(e){}
        limparErrosVisuais();
        v.recebedor.textContent='Recebedor'; v.docRecebedor.textContent='CPF/CNPJ'; v.recebedor2.textContent='Recebedor';
        v.pagador.textContent='Pagador'; v.docPagador.textContent='000.000.000-00'; v.valor.textContent=nf.format(0); v.valor2.textContent=nf.format(0);
        v.extenso.textContent='zero real'; v.descricao.textContent='Descrição'; v.forma.textContent='PIX'; v.obs.textContent='Observações'; v.numero.textContent='00001';
        v.dataTop.textContent = formatDate(today); v.cidadeData.textContent = `Cidade/UF, ${formatDate(today)}`;
        showToast('Formulário limpo!');
      });

      // signature wiring
      document.getElementById('assinar').addEventListener('click', e=>{ e.preventDefault(); openSignature(); });
      document.getElementById('sigCancel').addEventListener('click', e=>{ e.preventDefault(); closeSignatureModal(); });
      document.getElementById('sigSave').addEventListener('click', e=>{ e.preventDefault(); saveSignature(); });
      document.getElementById('sigClear').addEventListener('click', e=>{ e.preventDefault(); clearSig(); });

      document.getElementById('clearSignatureInline').addEventListener('click', e=>{ e.preventDefault(); const img=document.getElementById('signatureImg'); if(img){ img.src=''; img.style.display='none'; } const t=document.getElementById('trace'); if(t) t.style.display='block'; });

      // inputs update preview live
      Object.values(campos).forEach(el=>{ if(el && el.type!=='file') el.addEventListener('input', ()=>atualizarPreview(false)); });

      // initial preview
      const initial = campos.data.value ? parseDateInput(campos.data.value) : today;
      v.dataTop.textContent = formatDate(initial);
      v.cidadeData.textContent = `Cidade/UF, ${formatDate(initial)}`;
      atualizarPreview(false);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>